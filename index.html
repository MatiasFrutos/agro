<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agronomía Inteligente SRL — Datos personales</title>

  <!-- Librerías para PDF (se usa al enviar a Jira) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#f9fafb; --panel:#ffffff;
      --ink:#111827; --mut:#6b7280;
      --line:#111827; --line-soft:#e5e7eb;
      --accent:#facc15; /* amarillo */
      --accent-ink:#111827;
      --radius:14px; --pad:16px; --shadow:0 1px 0 rgba(17,24,39,.06);
      --input:#ffffff; --input-bd:#111827; --input-h:#fffef3;
    }
    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color:var(--ink);
    }
    .wrap{ max-width: 1100px; margin: 24px auto 40px; padding: 0 16px; }
    header.h{ margin-bottom:16px; }
    .brand{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .brand-logo{ height:44px; width:auto; object-fit:contain; }
    .brand h1{ margin:0; font-size: clamp(22px, 3vw, 30px); line-height:1.1; }
    .brand .sub{ margin:0; color:var(--mut); font-size: clamp(14px, 2vw, 16px); }
    .bar-yellow{ height:3px; background: var(--accent); margin-top:10px; border-radius:2px; }

    .notice{
      margin: 6px 0 12px;
      background:#fffef3; border:1px solid var(--accent); color:var(--ink);
      border-radius:10px; padding:10px 12px; font-size:.95rem;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--line);
      border-top:4px solid var(--accent); /* línea amarilla */
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    form.grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .section-title{
      grid-column: 1 / -1;
      font-weight:700; font-size: 1.05rem;
      border-bottom:1px solid var(--line);
      padding-bottom:6px; margin-top:6px;
    }
    .field{
      grid-column: span 12;
      display:flex; flex-direction:column; gap:6px;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: 10px; padding: 10px;
    }
    .field.half{ grid-column: span 6; }
    .field.third{ grid-column: span 4; }
    .field.two{ grid-column: span 2; }
    .field label{ font-size: .94rem; }
    .req::after{ content:" *"; color:#b91c1c; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="time"], input[type="date"], select, textarea{
      background: var(--input);
      border:1px solid var(--input-bd);
      color:var(--ink);
      padding: 11px 12px;
      border-radius: 8px;
      outline: none;
      transition: .15s border, .15s background;
      width:100%;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input:focus, select:focus, textarea:focus{ border-color: var(--accent); background: var(--input-h); }
    .help{ color:var(--mut); font-size: .85rem; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chips .chip{
      border:1px solid var(--line);
      padding:6px 10px; border-radius:999px; cursor:pointer;
      background:#fff;
    }
    .chips input{ margin-right:6px; }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px;
    }
    .actions-bottom{ justify-content: flex-end; margin-top: 18px; }
    @media (max-width: 720px){ .actions-bottom{ justify-content: center; } }
    button{
      border:1px solid var(--line); border-radius: 10px; padding: 12px 16px; cursor:pointer;
      font-weight:600; background:#fff; color:var(--ink);
    }
    .primary{ background: var(--accent); color: var(--accent-ink); }
    .danger{ background: #fff; border-color:#ef4444; color:#b91c1c; }
    button:disabled{ opacity:.6; cursor: not-allowed; }

    .error{ border-color: #ef4444 !important; box-shadow: 0 0 0 2px rgba(239,68,68,.15); }
    .hr{ height:2px; background: var(--accent); margin: 14px 0; border-radius: 99px; }
    footer{ margin-top: 18px; color:var(--mut); font-size:.9rem; text-align:center; }

    /* Firma canvas */
    #sigWrap{ background:#fff; border:2px dashed var(--line); border-radius:10px; padding:10px; }
    #sigCanvas{ width:100%; height:200px; display:block; background:#fff; border-radius:6px; touch-action: none; }
    .sig-label{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .sig-hint{ color:var(--mut); font-size:.85rem; }

    @media (max-width: 900px){
      .field.half{ grid-column: span 12; }
      .field.third{ grid-column: span 12; }
      .field.two{ grid-column: span 6; }
      .brand-logo{ height:36px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="h">
      <div class="brand">
        <img id="logo" class="brand-logo" src="logo.png" alt="Logo Agronomía Inteligente SRL"/>
        <div>
          <h1>Agronomía Inteligente SRL</h1>
          <div class="sub">Datos personales</div>
        </div>
      </div>
      <div class="bar-yellow"></div>
      <div class="notice">Importante: <strong>siempre solicitamos Factura A</strong>. Si no contás con Factura A, informanos antes de continuar.</div>
    </header>

    <section class="panel">
      <form id="frm" class="grid" onsubmit="return false">
        <div class="section-title">Identificación</div>
        <div class="field half">
          <label class="req" for="nombre">Nombre y Apellido</label>
          <input id="nombre" type="text" placeholder="Ej: Juan Pérez" required/>
        </div>
        <div class="field third">
          <label class="req" for="dni">DNI / CUIT</label>
          <input id="dni" type="text" placeholder="Ej: 20-12345678-3" required/>
        </div>
        <div class="field third">
          <label class="req" for="email">Email</label>
          <input id="email" type="email" placeholder="ejemplo@correo.com" required/>
        </div>
        <div class="field third">
          <label class="req" for="tel">Teléfono</label>
          <input id="tel" type="tel" placeholder="+54 9 11 1234-5678" required/>
        </div>

        <div class="section-title">Ubicación</div>
        <div class="field half">
          <label class="req" for="ciudad">Ciudad / Provincia</label>
          <input id="ciudad" type="text" placeholder="Ej: San Martín, Buenos Aires" required/>
          <div class="help">Se usa para asignación de zonas y logística.</div>
        </div>

        <div class="section-title">Datos de pago y facturación</div>
        <div class="field third">
          <label class="req" for="cbu">CBU / Alias</label>
          <input id="cbu" type="text" placeholder="CBU o alias" required/>
        </div>
        <div class="field third">
          <label class="req" for="bancoPago">Banco donde se paga</label>
          <input id="bancoPago" type="text" placeholder="Ej: Banco Nación" required/>
        </div>
        <div class="field third">
          <label class="req" for="fact">Tipo de Factura</label>
          <select id="fact" required>
            <option selected>Factura A</option>
            <option>Factura B</option>
            <option>Factura C</option>
            <option>Monotributo (A)</option>
          </select>
          <div class="help">Recordatorio: siempre solicitamos <strong>Factura A</strong>.</div>
        </div>

        <div class="field third">
          <label class="req" for="condicion">Condición fiscal</label>
          <select id="condicion" required>
            <option value="">Seleccionar…</option>
            <option>Monotributista</option>
            <option>Responsable Inscripto</option>
            <option>Autónomo</option>
          </select>
          <div class="help">Indicá si sos monotributista, responsable inscripto o autónomo.</div>
        </div>

        <div class="section-title">Modalidad de trabajo y cobertura</div>
        <div class="field">
          <label class="req">Modalidad de trabajo</label>
          <div class="row chips">
            <label class="chip"><input type="checkbox" name="modal" value="Vendedor / Distribuidor">Vendedor / Distribuidor</label>
            <label class="chip"><input type="checkbox" name="modal" value="Instalador">Instalador</label>
            <label class="chip"><input type="checkbox" name="modal" value="Otros">Otros</label>
            <input id="modalOtro" type="text" placeholder="Especifique (si eligió Otros)" style="flex:1; min-width:220px;">
          </div>
        </div>
        <div class="field third">
          <label class="req" for="radioKm">Radio de cobertura (km)</label>
          <input id="radioKm" type="number" min="1" step="1" placeholder="Ej: 150" required/>
        </div>

        <div class="section-title">Disponibilidad</div>
        <div class="field half">
          <label class="req">Días disponibles</label>
          <div class="row chips">
            <label class="chip"><input type="checkbox" name="dia" value="Lun">Lun</label>
            <label class="chip"><input type="checkbox" name="dia" value="Mar">Mar</label>
            <label class="chip"><input type="checkbox" name="dia" value="Mié">Mié</label>
            <label class="chip"><input type="checkbox" name="dia" value="Jue">Jue</label>
            <label class="chip"><input type="checkbox" name="dia" value="Vie">Vie</label>
            <label class="chip"><input type="checkbox" name="dia" value="Sáb">Sáb</label>
            <label class="chip"><input type="checkbox" name="dia" value="Dom">Dom</label>
          </div>
        </div>
        <div class="field half">
          <label class="req">Franja horaria disponible</label>
          <div class="row">
            <div>
              <div class="help">Desde</div>
              <input id="horaDesde" type="time" required>
            </div>
            <div>
              <div class="help">Hasta</div>
              <input id="horaHasta" type="time" required>
            </div>
          </div>
        </div>

        <div class="section-title">Firma</div>
        <div class="field">
          <div class="sig-label">
            <label for="sigCanvas" class="req">Firma del Técnico</label>
            <span class="sig-hint">Dibuje dentro del recuadro usando mouse o dedo</span>
          </div>
          <div id="sigWrap">
            <canvas id="sigCanvas"></canvas>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="btnClearSig" type="button">Limpiar firma</button>
          </div>
        </div>

        <div class="section-title">Otros</div>
        <div class="field">
          <label for="obs">Observaciones</label>
          <textarea id="obs" placeholder="Experiencia, equipamiento, movilidad, etc."></textarea>
        </div>
        <div class="field half">
          <label class="req" for="lugar">Lugar</label>
          <input id="lugar" type="text" placeholder="Ej: Buenos Aires" required/>
        </div>
        <div class="field third">
          <label class="req" for="fecha">Fecha</label>
          <input id="fecha" type="date" required/>
        </div>
      </form>
    </section>

    <!-- Acciones al final de la página -->
    <div class="actions actions-bottom">
      <button id="btnJira" class="primary" type="button">Enviar datos personales</button>
      <button id="btnLimpiar" class="danger" type="button">Limpiar todo</button>
    </div>

    <footer>© Agronomía Inteligente SRL</footer>
  </div>

<script>
  // ============== Utils ==============
  function $(id){ return document.getElementById(id); }
  function getChecks(name){
    return Array.from(document.querySelectorAll('input[name="'+name+'"]:checked')).map(x=>x.value);
  }
  function getFormValues(){
    const seleccion = getChecks('modal');
    const otro = $('modalOtro').value.trim();
    const modalidades = seleccion.concat(otro ? ['Otros: '+otro] : []).join(', ');

    return {
      nombre: $('nombre').value.trim(),
      dni: $('dni').value.trim(),
      email: $('email').value.trim().toLowerCase(),
      tel: $('tel').value.trim(),
      ciudad: $('ciudad').value.trim(),
      cbu: $('cbu').value.trim(),
      bancoPago: $('bancoPago').value.trim(),
      fact: $('fact').value,
      condicion: $('condicion').value,
      modalidades,
      radioKm: $('radioKm').value.trim(),
      diasDisponibles: getChecks('dia').join(', ') || '',
      horaDesde: $('horaDesde').value,
      horaHasta: $('horaHasta').value,
      obs: $('obs').value.trim(),
      lugar: $('lugar').value.trim(),
      fecha: $('fecha').value
    };
  }
  function validar(){
    const reqIds = ['nombre','dni','email','tel','ciudad','cbu','bancoPago','fact','condicion','radioKm','horaDesde','horaHasta','lugar','fecha'];
    let ok = true;
    document.querySelectorAll('.error').forEach(el=>el.classList.remove('error'));

    for (const id of reqIds){
      const el = $(id);
      if (!el) continue;
      const val = (el.type === 'text' || el.type === 'email' || el.tagName === 'TEXTAREA')
        ? el.value.trim() : el.value;
      if (!val){
        el.classList.add('error'); ok = false;
      }
    }
    // normalizar email
    const emailInput = $('email');
    const em = emailInput.value.trim().toLowerCase();
    emailInput.value = em;
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)){
      emailInput.classList.add('error'); ok = false;
    }

    const mods = getChecks('modal');
    const otro = $('modalOtro').value.trim();
    if (mods.length === 0 && !otro){
      const cont = document.querySelector('.chips');
      cont && (cont.style.outline = '2px solid #ef4444', setTimeout(()=>cont.style.outline='none', 1500));
      ok = false;
    }

    if (!ok) alert('Revisá los campos marcados en rojo.');
    return ok;
  }
  function limpiarFormulario(){ $('frm').reset(); clearSignature(); }

  // ============== Firma (canvas) con preservación al redimensionar ==============
  const sig = { canvas:null, ctx:null, drawing:false, hasStroke:false, scale:1, _rz:null };
  function initSignature(){
    sig.canvas = $('sigCanvas');
    sig.ctx = sig.canvas.getContext('2d');
    resizeSignatureCanvas({ preserve:false }); // init
    sig.ctx.lineWidth = 2;
    sig.ctx.lineCap = 'round';
    sig.ctx.strokeStyle = '#111827';

    // Mejor soporte táctil
    const pos = e => {
      const rect = sig.canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : (e.clientX ?? e.pageX);
      const clientY = e.touches ? e.touches[0].clientY : (e.clientY ?? e.pageY);
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      return { x: x * sig.scale, y: y * sig.scale };
    };

    const start = e => { e.preventDefault(); sig.drawing = true; sig.ctx.beginPath(); const p = pos(e); sig.ctx.moveTo(p.x, p.y); };
    const move  = e => { if(!sig.drawing) return; const p = pos(e); sig.ctx.lineTo(p.x, p.y); sig.ctx.stroke(); sig.hasStroke = true; };
    const end   = e => { if(!sig.drawing) return; sig.drawing = false; };

    // Mouse
    sig.canvas.addEventListener('mousedown', start);
    sig.canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    // Touch
    sig.canvas.addEventListener('touchstart', start, {passive:false});
    sig.canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end);

    $('btnClearSig').addEventListener('click', clearSignature);

    // Preservar la firma ante cambios de viewport (scroll en móvil / barra del navegador / rotación)
    const debounced = () => {
      clearTimeout(sig._rz);
      sig._rz = setTimeout(() => resizeSignatureCanvas({ preserve:true }), 120);
    };
    window.addEventListener('resize', debounced);
    window.addEventListener('orientationchange', () => setTimeout(() => resizeSignatureCanvas({ preserve:true }), 250));
  }
  function resizeSignatureCanvas({ preserve } = { preserve:false }){
    let data = null, had = false;
    if (preserve && sig.canvas) { // capturar estado actual
      data = sig.canvas.toDataURL('image/png');
      had = sig.hasStroke;
    }
    const dpr = window.devicePixelRatio || 1;
    const cssW = sig.canvas.clientWidth;
    const cssH = sig.canvas.clientHeight || 200;
    sig.canvas.width = Math.floor(cssW * dpr);
    sig.canvas.height = Math.floor(cssH * dpr);
    sig.scale = dpr;
    // fondo blanco
    sig.ctx.fillStyle = '#ffffff'; sig.ctx.fillRect(0,0,sig.canvas.width,sig.canvas.height);

    if (data){
      const img = new Image();
      img.onload = () => {
        sig.ctx.drawImage(img, 0, 0, sig.canvas.width, sig.canvas.height);
        sig.hasStroke = had;
      };
      img.src = data;
    }else{
      sig.hasStroke = false;
    }
  }
  function clearSignature(){
    if (!sig.ctx) return;
    sig.ctx.clearRect(0,0,sig.canvas.width,sig.canvas.height);
    sig.ctx.fillStyle = '#ffffff'; sig.ctx.fillRect(0,0,sig.canvas.width,sig.canvas.height);
    sig.hasStroke = false;
  }
  function getSignatureDataURL(){
    if (!sig.canvas) return null;
    if (!sig.hasStroke) return null;
    return sig.canvas.toDataURL('image/png');
  }

  // ============== Logo (para PDF) ==============
  async function getLogoDataURL(){
    const imgEl = $('logo');
    if (imgEl && imgEl.complete && imgEl.naturalWidth){
      const c = document.createElement('canvas');
      c.width = imgEl.naturalWidth; c.height = imgEl.naturalHeight;
      const cx = c.getContext('2d');
      cx.drawImage(imgEl, 0, 0);
      try{ return c.toDataURL('image/png'); }catch(e){}
    }
    try{
      const resp = await fetch('logo.png', {cache:'no-store'});
      if (!resp.ok) throw new Error('no logo');
      const blob = await resp.blob();
      return await new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  // ============== PDF (se genera al enviar) ==============
  async function generarPDFDatosBlob(){
    const vals = getFormValues();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const W = doc.internal.pageSize.getWidth();

    // Encabezado con logo
    const logoData = await getLogoDataURL();
    if (logoData){
      const logoW = 110, logoH = 44;
      doc.addImage(logoData, 'PNG', 40, 24, logoW, logoH);
      doc.setTextColor(17,24,39);
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('Agronomía Inteligente SRL', 40 + logoW + 14, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text('Datos personales', 40 + logoW + 14, 60);
    }else{
      doc.setTextColor(17,24,39);
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('Agronomía Inteligente SRL', 40, 40);
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text('Datos personales', 40, 60);
    }

    // Línea amarilla
    doc.setDrawColor(250, 204, 21);
    doc.setLineWidth(2);
    doc.line(40, 70, W-40, 70);

    // Tabla
    doc.setTextColor(17,24,39);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);

    const rows = [
      ['Nombre y Apellido', vals.nombre],
      ['DNI / CUIT', vals.dni],
      ['Email', vals.email],
      ['Teléfono', vals.tel],
      ['Ciudad / Provincia', vals.ciudad],
      ['CBU / Alias', vals.cbu],
      ['Banco donde se paga', vals.bancoPago],
      ['Tipo de Factura', vals.fact],
      ['Condición fiscal', vals.condicion],
      ['Modalidad de trabajo', vals.modalidades],
      ['Radio de cobertura (km)', vals.radioKm],
      ['Días disponibles', vals.diasDisponibles],
      ['Franja horaria', (vals.horaDesde||'') + ' a ' + (vals.horaHasta||'')],
      ['Observaciones', vals.obs || '-'],
      ['Lugar', vals.lugar],
      ['Fecha', vals.fecha]
    ];

    doc.autoTable({
      startY: 90,
      styles: { font: 'helvetica', fontSize: 10, cellPadding: 6, halign:'left', textColor:[17,24,39], lineColor:[17,24,39], lineWidth:0.5 },
      headStyles: { fillColor: [250,204,21], textColor:[17,24,39], fontStyle:'bold', lineColor:[17,24,39], lineWidth:0.5 },
      tableLineColor: [17,24,39],
      tableLineWidth: 0.8,
      head: [['Campo','Valor']],
      body: rows
    });

    // Bloque de firma
    let y = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : 90) + 24;
    const sigW = W - 80, sigH = 140;
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    doc.setTextColor(17,24,39);
    doc.text('Firma del Técnico', 40, y);
    y += 8;
    // marco
    doc.setDrawColor(17,24,39); doc.setLineWidth(0.8);
    doc.rect(40, y, sigW, sigH);

    const sigData = getSignatureDataURL();
    if (sigData){
      const pad = 10;
      const boxW = sigW - pad*2, boxH = sigH - pad*2;
      doc.addImage(sigData, 'PNG', 40+pad, y+pad, boxW, boxH);
    } else {
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text('_______________________________', 50, y + sigH - 16);
      doc.text('Aclaración / DNI', 50, y + sigH - 4);
    }

    const fileName = `DatosPersonales_${(vals.nombre||'persona').replace(/\s+/g,'_')}.pdf`;
    const blob = doc.output('blob');
    return { blob, fileName, vals };
  }

  // ============== Jira por proxy (usa el PDF) ==============
  const PROXY_URL = 'https://jira-proxy-production.up.railway.app'; // Cambiar si usás otro endpoint
  function toADF(paragraphs){
    return {
      version: 1, type: 'doc',
      content: paragraphs.map(t => ({ type:'paragraph', content: [{ type:'text', text:String(t||'') }]}))
    };
  }
  async function enviarAJiraViaProxy({blob, fileName, vals}){
    const lines = [
      `Nombre: ${vals.nombre} — DNI/CUIT: ${vals.dni}`,
      `Email: ${vals.email} | Tel: ${vals.tel}`,
      `Ciudad/Provincia: ${vals.ciudad}`,
      `CBU/Alias: ${vals.cbu} | Banco donde se paga: ${vals.bancoPago}`,
      `Tipo de factura: ${vals.fact} (Recordatorio: se solicita Factura A)`,
      `Condición fiscal: ${vals.condicion}`,
      `Modalidad de trabajo: ${vals.modalidades}`,
      `Cobertura: Radio ${vals.radioKm} km`,
      `Días disponibles: ${vals.diasDisponibles}`,
      `Franja horaria disponible: ${vals.horaDesde} a ${vals.horaHasta}`,
      `Observaciones: ${vals.obs || '-'}`,
      `Lugar/Fecha: ${vals.lugar} — ${vals.fecha}`,
      '',
      'Adjunto: Datos personales en PDF.'
    ];
    const descriptionADF = toADF(lines);

    const pdfBase64 = await new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result).split(',')[1]);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 20000);

    const resp = await fetch(`${PROXY_URL}/api/contrato/json`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        summary: `Datos personales — ${vals.nombre}`,
        labels: ['tecnicos','datos'],
        descriptionADF,
        pdfBase64,
        pdfFilename: fileName
      }),
      mode: 'cors',
      signal: controller.signal
    }).catch(err => {
      clearTimeout(t);
      throw new Error('No se pudo conectar al proxy (CORS/red): ' + err.message);
    });
    clearTimeout(t);

    if (!resp.ok){
      const text = await resp.text().catch(()=> '');
      throw new Error(`Proxy respondió ${resp.status}: ${text || 'sin detalle'}`);
    }
    const data = await resp.json();
    if (!data?.key) throw new Error('Respuesta del proxy sin issue key');
    return data.key;
  }

  // ============== Listeners ==============
  (function init(){
    initSignature();

    // Fecha por defecto
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    if (!$('fecha').value) $('fecha').value = `${yyyy}-${mm}-${dd}`;

    const btnJira = $('btnJira');
    if (btnJira){
      btnJira.addEventListener('click', async ()=>{
        try{
          if (!validar()) return;
          btnJira.disabled = true;
          const old = btnJira.textContent;
          btnJira.textContent = 'Enviando…';

          const pkg = await generarPDFDatosBlob();
          const issueKey = await enviarAJiraViaProxy(pkg);
          alert(`Contrato enviado. Ticket: ${issueKey}`);

          btnJira.textContent = old;
          btnJira.disabled = false;
        }catch(err){
          console.error(err);
          alert('Error al enviar a Jira:\n' + (err?.message || err));
          btnJira.textContent = 'Enviar datos personales';
          btnJira.disabled = false;
        }
      });
    }

    const btnLimpiar = $('btnLimpiar');
    if (btnLimpiar){ btnLimpiar.addEventListener('click', limpiarFormulario); }
  })();
</script>
</body>
</html>
